BEGIN TRANSACTION

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, QUOTED_IDENTIFIER, CONCAT_NULL_YIELDS_NULL ON
SET NUMERIC_ROUNDABORT OFF

IF @@ERROR <> 0
   IF @@TRANCOUNT = 1 ROLLBACK TRANSACTION

IF @@TRANCOUNT = 1
BEGIN
	DECLARE @OrganizationId uniqueidentifier
	DECLARE @Value nvarchar(100)

	DECLARE Cursor1 CURSOR FOR
	SELECT DISTINCT ([OrganizationId]) AS [OrganizationId]
	FROM  [dbo].[Mc_SettingsValues]
	WHERE [SettingId] IN  ('00000000-0000-0000-0000-000000000083', '00000000-0000-0000-0000-000000000084', '00000000-0000-0000-0000-000000000085')

	OPEN Cursor1

	FETCH NEXT FROM Cursor1
	INTO @OrganizationId

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT @Value = (CASE WHEN ([SettingId] = '00000000-0000-0000-0000-000000000083' AND LOWER([Value]) = N'true')
			OR ([SettingId] = '00000000-0000-0000-0000-000000000084' AND LOWER([Value]) = N'true')
			OR ([SettingId] = '00000000-0000-0000-0000-000000000085' AND LOWER([Value]) = N'true')
			THEN N'true' ELSE N'false' END)
		FROM [dbo].[Mc_SettingsValues]
		WHERE [OrganizationId] = @OrganizationId
			AND [SettingId] IN ('00000000-0000-0000-0000-000000000083', '00000000-0000-0000-0000-000000000084', '00000000-0000-0000-0000-000000000085')
	
		IF (@Value IS NULL OR @Value = N'true')
			DELETE FROM [dbo].[Mc_SettingsValues]
			WHERE [OrganizationId] = @OrganizationId AND [SettingId] = '00000000-0000-0000-0000-000000000083'
		ELSE IF EXISTS(SELECT 0 FROM [dbo].[Mc_SettingsValues] WHERE [OrganizationId] = @OrganizationId AND [SettingId] = '00000000-0000-0000-0000-000000000083')
			UPDATE [dbo].[Mc_SettingsValues]
			SET [Value] = @Value
			WHERE [OrganizationId] = @OrganizationId AND [SettingId] = '00000000-0000-0000-0000-000000000083'
		ELSE
			INSERT INTO [dbo].[Mc_SettingsValues] ([SettingValueId], [SettingId], [Value], [OrganizationId], [InstanceId], [GroupId])
			VALUES	(NEWID(), '00000000-0000-0000-0000-000000000083', @Value, @OrganizationId, NULL, NULL)

		FETCH NEXT FROM Cursor1
		INTO @OrganizationId
	END

	CLOSE Cursor1
	DEALLOCATE Cursor1
END

IF @@ERROR <> 0
   IF @@TRANCOUNT = 1 ROLLBACK TRANSACTION

IF @@TRANCOUNT = 1
	DELETE FROM [dbo].[Mc_SettingsValues]
	WHERE [SettingId] IN  ('00000000-0000-0000-0000-000000000084', '00000000-0000-0000-0000-000000000085')

IF @@ERROR <> 0
   IF @@TRANCOUNT = 1 ROLLBACK TRANSACTION

IF @@TRANCOUNT = 1
   COMMIT TRANSACTION
