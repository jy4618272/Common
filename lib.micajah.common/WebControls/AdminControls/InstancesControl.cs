using System;
using System.Web.UI.WebControls;
using Micajah.Common.Bll;
using Micajah.Common.Bll.Providers;
using Micajah.Common.Configuration;
using Micajah.Common.Properties;
using Micajah.Common.Security;
using Micajah.Common.WebControls.SetupControls;

namespace Micajah.Common.WebControls.AdminControls
{
    /// <summary>
    /// The control to manage instances.
    /// </summary>
    public class InstancesControl : BaseControl
    {
        #region Members

        private UserContext m_UserContext;

        #endregion

        #region Private Methods

        private void Redirect()
        {
            if (m_UserContext.InstanceId == (Guid)EditForm.DataKey[0])
            {
                Micajah.Common.Bll.Action action = ActionProvider.PagesAndControls.FindByActionId(ActionProvider.InstancesPageActionId);
                if (action != null)
                    Response.Redirect(action.AbsoluteNavigateUrl);
            }
        }

        #endregion

        #region Overriden Methods

        protected override void ListInitialize()
        {
            base.ListInitialize();

            List.AutoGenerateEditButton = false;
            List.AutoGenerateDeleteButton = false;
        }

        protected override void EditFormInitialize()
        {
            base.EditFormInitialize();

            EditForm.Fields[6].Visible = m_UserContext.IsFrameworkAdministrator && FrameworkConfiguration.Current.WebApplication.Integration.Chargify.Enabled;
            EditForm.AutoGenerateDeleteButton = (InstanceProvider.GetInstances(m_UserContext.OrganizationId, false).Count > 1);

            EditForm.ItemDeleted += new DetailsViewDeletedEventHandler(EditForm_ItemDeleted);
            EditForm.DataBound += new EventHandler(EditForm_DataBound);
        }

        protected override void EditFormReset()
        {
            base.EditFormReset();

            EditForm.AutoGenerateDeleteButton = (InstanceProvider.GetInstances(m_UserContext.OrganizationId, false).Count > 1);
        }

        protected override void LoadResources()
        {
            base.LoadResources();

            List.Columns[0].HeaderText = Resources.InstancesControl_List_NameColumn_HeaderText;

            EditForm.Fields[1].HeaderText = Resources.InstancesControl_EditForm_VanityUrlField_HeaderText;
            EditForm.Fields[2].HeaderText = Resources.InstancesControl_EditForm_TemplateField_HeaderText;
        }

        protected override void List_PageIndexChanged(object sender, EventArgs e)
        {
        }

        protected override void List_Action(object sender, CommonGridViewActionEventArgs e)
        {
            base.List_Action(sender, e);

            switch (e.Action)
            {
                case CommandActions.Add:
                    EditForm.Fields[1].Visible = true;
                    EditForm.Fields[2].Visible = true;
                    break;

                default:
                    EditForm.Fields[1].Visible = false;
                    EditForm.Fields[2].Visible = false;
                    break;
            }
        }

        protected override void EditForm_ItemUpdated(object sender, DetailsViewUpdatedEventArgs e)
        {
            base.EditForm_ItemUpdated(sender, e);

            if (e == null) return;

            if (e.Exception != null) return;

            if (m_UserContext.IsFrameworkAdministrator)
            {
                ComboBox cmb = EditForm.FindControl("cmbBillingPlan") as ComboBox;
                int val = 0;
                if (cmb != null && int.TryParse(cmb.SelectedValue, out val))
                {
                    Guid instId = (Guid)EditForm.DataKey[0];
                    Instance inst = m_UserContext.Instance;
                    if (inst == null || inst.InstanceId != instId) inst = InstanceProvider.GetInstance(instId);
                    if (inst.BillingPlan != BillingPlan.Custom && val == 1) InstanceProvider.UpdateInstance(inst, BillingPlan.Custom);
                    else if (inst.BillingPlan == BillingPlan.Custom && val == 0)
                    {
                        ChargifyNET.ChargifyConnect _chargify = ChargifyProvider.CreateChargify();
                        ChargifyNET.ISubscription _custSubscr = ChargifyProvider.GetCustomerSubscription(_chargify, inst.OrganizationId, inst.InstanceId);
                        SettingCollection settings=CounterSettingProvider.GetLastModifiedPaidSettings(inst.OrganizationId, inst.InstanceId, null);
                        ChargifyProvider.UpdateSubscriptionAllocations(_chargify, _custSubscr != null ? _custSubscr.SubscriptionID : 0, inst, settings, settings);
                    }
                }
            }

            this.Redirect();
        }

        protected override void OnInit(EventArgs e)
        {
            m_UserContext = UserContext.Current;

            base.OnInit(e);
        }

        #endregion

        #region Protected Methods

        protected void List_DataBound(object sender, EventArgs e)
        {
            if (!this.IsPostBack)
            {
                if (string.IsNullOrEmpty(List.SortExpression))
                    List.Sort("Name", SortDirection.Ascending);
            }
        }

        protected void List_RowEditing(object sender, GridViewEditEventArgs e)
        {
            if (e == null) return;

            e.Cancel = true;

            this.List_Action(sender, new CommonGridViewActionEventArgs(CommandActions.Edit, e.NewEditIndex));
        }

        protected void EditForm_ItemDeleted(object sender, DetailsViewDeletedEventArgs e)
        {
            if (e == null) return;

            if (ShowError(e.Exception))
                e.ExceptionHandled = true;
            else
                EditFormReset();
        }

        protected void EditForm_DataBound(object sender, EventArgs e)
        {
            ComboBox cmb = EditForm.FindControl("cmbBillingPlan") as ComboBox;
            if (cmb != null && EditForm.DataItem != null)
            {
                cmb.SelectedValue = ((Instance)EditForm.DataItem).BillingPlan == BillingPlan.Custom ? "1" : "0";
            }
            else cmb.SelectedValue = "0";
        }

        protected void EntityDataSource_Inserting(object sender, ObjectDataSourceMethodEventArgs e)
        {
            if (e != null)
            {
                TextBox PartialCustomUrlTextBox = EditForm.FindControl("PartialCustomUrlTextBox") as TextBox;
                if (PartialCustomUrlTextBox != null)
                    e.InputParameters["vanityUrl"] = PartialCustomUrlTextBox.Text;


                DropDownList TemplateList = EditForm.FindControl("TemplateList") as DropDownList;
                if (TemplateList != null)
                    e.InputParameters["templateInstanceId"] = new Guid(TemplateList.SelectedValue);
            }
        }

        #endregion
    }
}

